#!/bin/sh

dotsync() {
    local hostconf dotdir moduledir installscript action module
    hostconf="${1}"
    dotdir="${2}"
    for module in $(ls "${dotdir}"); do
        moduledir="${dotdir}/${module}"
        installscript="${moduledir}/install.sh"
        if [ ! -d "${moduledir}" ]; then
            echo >&2 "$(withaf f80 '[WARNING]') not a dir: ${f}"
            continue
        fi

        # if ! grep -Fqx "${module}" "${hostconf}"; then
        #     dotdown "${moduledir}"
        # fi
    done
    for module in $(cat "${hostconf}"); do
        case "${module}" in
            '#'*)
                continue
                ;;
            '!'*)
                module="${module#!}"
                action=dotdown
                ;;
            '+'*)
                module="${module#+}"
                action=dotsync
                ;;
            *)
                action=dotup
                ;;
        esac
        module="$(echo "${module}" | sed 's/^\s*//' | sed 's/\s*$//')"

        case "${action}" in
            dotsync)
                moduledir="${dotdir}/../boxen" # FIXME I expect boxen to be here, but...
                installscript="${moduledir}/${module}"
                if [ ! -f "${installscript}" ]; then
                    echo >&2 "$(withaf f00 '[ERROR]') Could not find configuration file for '${module}' at '${moduledir}'."
                    echo >&2 "Skipping ${module}."
                else
                    echo >&2 "$(withaf 08f '[INFO]') START including from '${module}'"
                    dotsync "${installscript}" "${dotdir}"
                    echo >&2 "$(withaf 08f '[INFO]') DONE including from '${module}'"
                fi
                ;;
            *)
                moduledir="${dotdir}/${module}"
                installscript="${moduledir}/install.sh"

                if [ ! -f "${installscript}" ]; then
                    echo >&2 "No install script for '${module}' (expecting '${installscript}')."
                    echo >&2 "Skipping ${module}."
                else
                    "${action}" "${moduledir}"
                fi
                ;;
        esac
    done
}

dotup() {
    local dotdir installscript state
    dotdir="${1}"
    case "${dotdir}" in
      /*) dotdir="${dotdir}";;
      *) dotdir="${PWD}/${dotdir}";;
    esac
    installscript="${dotdir}/install.sh"
    (
        echo >&2 "Syncing ${1}…"
        . "${installscript}"
        echo >&2 "Checking status…"
        if ! dotsync_depsgood "${dotdir}"; then
            echo >&2 "Missing dependencies."
            state=SKIP
        elif dotsync_newest "${dotdir}"; then
            echo >&2 "Already up-to-date."
            state=up-to-date
        else
            # FIXME I think I don't need to teardown
            # echo >&2 "Preparing clean slate…"
            # if ! dotsync_teardown "${dotdir}"; then
            #     echo >&2 "$(withaf f80 '[WARNING]') Teardown failed, but should never fail."
            #     state=FAIL
            #     return 1
            # fi
            echo >&2 "Updating ${1}…"
            if dotsync_setup "${dotdir}"; then
                state=ok
            else
                state=FAIL
            fi
        fi
        case ${state} in
            ok) echo >&2 "$(withaf 0f0 '[ok]') ${1}" ;;
            up-to-date) echo >&2 "$(withaf 0c0 '[up-to-date]') ${1}" ;;
            SKIP) echo >&2 "$(withaf 08f '[SKIP]') ${1}" ;;
            FAIL) echo >&2 "$(withaf f00 '[FAIL]') ${1}" ;;
            *) echo >&2 "$(withaf f80 '[WARNING]'): unknown state: ${1}" ;;
        esac
    )
}

dotdown() {
    local dotdir installscript
    dotdir="${1}"
    case "${dotdir}" in
      /*) dotdir="${dotdir}";;
      *) dotdir="${PWD}/${dotdir}";;
    esac
    installscript="${dotdir}/install.sh"
    echo >&2 "Tearing down ${dotdir}…"
    (
        . "${installscript}"
        dotsync_teardown "${dotdir}"
    )
    echo >&2 "done."
}
